<view class="page">
  <!-- 背景图 -->
  <image class="bg" src="/assets/background.jpg" mode="aspectFill" />
  <!-- 半透明遮罩 -->
  <view class="overlay"></view>

  <!-- 内容区 -->
  <view class="content">
    <!-- 顶部切换栏 -->
    <view class="order-tabs">
      <view class="tab {{currentOrderType==='dinein' ? 'active' : ''}}" data-type="dinein" bindtap="switchOrderType">堂食订单</view>
      <view class="tab {{currentOrderType==='takeaway' ? 'active' : ''}}" data-type="takeaway" bindtap="switchOrderType">外卖订单</view>
    </view>

    <!-- ====== 堂食订单展示 ====== -->
    <view class="orders-view" wx:if="{{currentOrderType==='dinein'}}">
      <block wx:if="{{dineInOrders.length}}">
        <block wx:for="{{dineInOrders}}" wx:for-item="o" wx:key="order_id">
          <view class="order-card">
            <view class="order-row">
              <text class="label">订单号：</text>
              <text class="value">{{o.order_id}}</text>
            </view>
            <view class="order-row">
              <text class="label">桌号：</text>
              <text class="value">{{o.table_number}}</text>
            </view>
            <view class="order-row">
              <text class="label">菜品：</text>
              <text class="value">{{o.dish_list}}</text>
            </view>
            <view class="order-row">
              <text class="label">金额：</text>
              <text class="value">￥{{o.priceFixed}}</text>
            </view>
            <view class="order-row">
              <text class="label">时间：</text>
              <text class="value">{{o.timeFormatted}}</text>
            </view>
            <view class="order-row">
                   <text class="label">备注：</text>
              <text class="value">{{o.remark || '无'}}</text>
            </view>
            <block wx:if="{{!o.paid}}">
              <button class="pay-btn" data-order-id="{{o.order_id}}" bindtap="showPayOptions">立即结账</button>
            </block>
            <block wx:else>
              <text class="paid-text">已支付</text>
            </block>
          </view>
        </block>
      </block>
      <view wx:else class="empty">暂无堂食订单</view>
    </view>

    <!-- ====== 外卖订单展示 ====== -->
    <view class="orders-view" wx:if="{{currentOrderType==='takeaway'}}">
      <block wx:if="{{takeawayOrders.length}}">
        <block wx:for="{{takeawayOrders}}" wx:for-item="item" wx:key="order_id">
          <view class="order-card">
            <view class="order-row">
              <text class="label">订单号：</text>
              <text class="value">{{item.order_id}}</text>
            </view>
            <view class="order-row">
              <text class="label">菜品：</text>
              <text class="value">{{item.dish_list}}</text>
            </view>
            <view class="order-row">
              <text class="label">地址：</text>
              <text class="value">{{item.delivery_address}}</text>
            </view>
            <view class="order-row">
              <text class="label">金额：</text>
              <text class="value">￥{{item.price}}</text>
            </view>
            <view class="order-row">
              <text class="label">使用优惠：</text>
              <text class="value">{{item.coupon ? '是，优惠￥' + item.discount : '否'}}</text>
            </view>
            <view class="order-row">
                 <text class="label">备注：</text>
                 <text class="value">{{item.remark || '无'}}</text>
            </view>
            <view class="order-row">
              <text class="label">状态：</text>
              <text class="value">
                <block wx:if="{{item.status==='delivered'}}">{{item.deliveryTime}} 已送达</block>
                <block wx:elif="{{item.status==='out_for_delivery'}}">派送中</block>
                <block wx:elif="{{item.status==='pending'}}">等待处理</block>
                <block wx:else>未知状态</block>
              </text>
            </view>
            <view wx:if="{{item.deliveryPersonId !== 0 && item.status=='out_for_delivery'}}" class="order-row">
              <text class="label">骑手：</text>
              <text class="value">骑手{{item.deliveryPersonId}}配送中</text>
            </view>

            <!-- 外卖确认收货按钮 -->
            <view class="action-btn" wx:if="{{item.status !== 'delivered'}}">
              <!-- 外卖订单确认按钮 -->
           <button bindtap="confirmDelivery" data-order-id="{{item.order_id}}">
              确认收货并结账
            </button>
            </view>
          </view>
        </block>
      </block>
      <view wx:else class="empty">暂无外卖订单</view>
    </view>
  </view>

  
  <!-- 支付弹窗 -->
  <view wx:if="{{showPayPopup}}" class="pay-popup-mask" bindtap="hidePayOptions">
    <view class="pay-popup" catchtap="true">
      <text class="popup-title">选择支付方式</text>
      <view class="pay-options">
        <view class="pay-option-btn" data-method="alipay" bindtap="pay">
          <image src="/assets/icons/alipay.png" mode="aspectFit" />
          <text>支付宝</text>
        </view>
        <view class="pay-option-btn" data-method="wechat" bindtap="pay">
          <image src="/assets/icons/wechat.png" mode="aspectFit" />
          <text>微信支付</text>
        </view>
        <view class="pay-option-btn" data-method="card" bindtap="pay">
          <image src="/assets/icons/card.png" mode="aspectFit" />
          <text>储值卡</text>
        </view>
      </view>
      <button class="cancel-btn" bindtap="hidePayOptions">取消</button>
    </view>
  </view>
  <!-- 底部 TabBar -->
  <view class="tabbar">
    <view class="tab-item" bindtap="switchTab" data-tab="home">
      <image class="tab-icon" src="/assets/tab/home-{{activeTab==='home'?'active':'inactive'}}.png" mode="aspectFit" />
      <text class="{{activeTab==='home'?'active':''}}">主页</text>
    </view>
    <view class="tab-item" bindtap="switchTab" data-tab="orders">
      <image class="tab-icon" src="/assets/tab/orders-{{activeTab==='orders'?'active':'inactive'}}.png" mode="aspectFit" />
      <text class="{{activeTab==='orders'?'active':''}}">订单</text>
    </view>
    <view class="tab-item" bindtap="switchTab" data-tab="review">
      <image class="tab-icon" src="/assets/tab/review-{{activeTab==='review'?'active':'inactive'}}.png"         mode="aspectFit" />
      <text class="{{activeTab==='review'?'active':''}}">评价</text>
    </view>
    <view class="tab-item" bindtap="switchTab" data-tab="profile">
      <image class="tab-icon" src="/assets/tab/profile-{{activeTab==='profile'?'active':'inactive'}}.png" mode="aspectFit" />
      <text class="{{activeTab==='profile'?'active':''}}">我的</text>
    </view>
  </view>
</view>
